<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gita Marg | Universal Wisdom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lora:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --saffron: #f4a261;
            --deep-saffron: #e76f51;
            --cream: #fdfaf5;
            --ink: #2c3e50;
            --stone-bg: #0a0a0c;
            --parchment: rgba(30, 30, 35, 0.9);
            --border: #374151;
        }

        body {
            font-family: 'Lora', serif;
            background-color: var(--stone-bg);
            color: #e5e7eb;
            overflow: hidden;
            transition: background-color 0.4s ease;
            position: relative;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Divine Background Animation */
        .divine-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            background: radial-gradient(circle at 50% 50%, #121220 0%, #050507 100%);
        }

        .aura {
            position: absolute;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(244, 162, 97, 0.08) 0%, transparent 70%);
            border-radius: 50%;
            filter: blur(100px);
            animation: moveAura 25s infinite alternate ease-in-out;
        }

        @keyframes moveAura {
            0% { transform: translate(-10%, -10%); }
            100% { transform: translate(15%, 20%); }
        }

        .particle {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0.15;
            pointer-events: none;
            animation: floatUp var(--d) linear infinite;
        }

        @keyframes floatUp {
            from { transform: translateY(110vh) scale(0); opacity: 0; }
            to { transform: translateY(-10vh) scale(1); opacity: 0.3; }
        }

        h1, h2, h3, .font-cinzel {
            font-family: 'Cinzel', serif;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--saffron) transparent;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .chat-container::-webkit-scrollbar { width: 6px; }
        .chat-container::-webkit-scrollbar-thumb { background-color: var(--saffron); border-radius: 10px; }

        .message-bubble {
            max-width: 85%;
            animation: fadeIn 0.4s ease-out forwards;
            position: relative;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .parchment {
            background: var(--parchment);
            border: 1px solid var(--border);
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            backdrop-filter: blur(12px);
        }

        .loader {
            width: 20px; height: 20px;
            border: 2px solid var(--saffron);
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .mood-btn {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            outline: none !important;
        }

        .mood-btn:hover {
            transform: translateY(-5px);
            background: rgba(244, 162, 97, 0.12);
            border-color: var(--saffron);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(20px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }
        .modal-content {
            background: #151515;
            border: 1px solid var(--border);
            border-radius: 2.5rem;
            max-width: 500px;
            width: 100%;
            padding: 2.5rem;
            text-align: center;
            box-shadow: 0 30px 60px rgba(0,0,0,0.6);
        }

        .message-row {
            display: flex;
            width: 100%;
            max-width: 800px;
            margin-bottom: 1.5rem;
        }
        .message-row.user { justify-content: flex-end; }
        .message-row.model { justify-content: flex-start; }

        .guide-text {
            line-height: 1.6;
            font-size: 1.05rem;
        }
        
        #messages-anchor {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
        }

        button:focus, textarea:focus {
            outline: none;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Instruction Pop-up -->
    <div id="instruction-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="font-cinzel text-2xl text-orange-500 mb-4 uppercase tracking-wider">Divine Guidance</h3>
            <p class="text-stone-300 leading-relaxed mb-8 italic text-base">
                This AI guide provides suggestions based on the Bhagavad Gita. These are insights for your reflection. The path you choose to take is your own decision and your own dharma.
            </p>
            <button onclick="closeInstruction()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-4 rounded-[1.2rem] transition-all shadow-2xl active:scale-95 text-base uppercase tracking-widest">
                I Understand
            </button>
        </div>
    </div>

    <!-- Language Selection -->
    <div id="language-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="font-cinzel text-xl text-orange-500 mb-2 uppercase tracking-wide">Select Language</h3>
            <p class="text-stone-400 text-xs mb-6 uppercase tracking-[0.2em]">10 Divine Tongues</p>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button onclick="setLang('English')" class="bg-white/5 border border-white/10 p-3 rounded-xl hover:bg-orange-500/10 hover:border-orange-500 transition-all text-xs font-bold tracking-widest">English</button>
                <button onclick="setLang('Hindi')" class="bg-white/5 border border-white/10 p-3 rounded-xl hover:bg-orange-500/10 hover:border-orange-500 transition-all text-xs font-bold tracking-widest">Hindi</button>
                <button onclick="setLang('Gujarati')" class="bg-white/5 border border-white/10 p-3 rounded-xl hover:bg-orange-500/10 hover:border-orange-500 transition-all text-xs font-bold tracking-widest">Gujarati</button>
                <button onclick="setLang('Sanskrit')" class="bg-white/5 border border-white/10 p-3 rounded-xl hover:bg-orange-500/10 hover:border-orange-500 transition-all text-xs font-bold tracking-widest">Sanskrit</button>
                <button onclick="setLang('Marathi')" class="bg-white/5 border border-white/10 p-3 rounded-xl hover:bg-orange-500/10 hover:border-orange-500 transition-all text-xs font-bold tracking-widest">Marathi</button>
                <button onclick="setLang('Tamil')" class="bg-white/5 border border-white/10 p-3 rounded-xl hover:bg-orange-500/10 hover:border-orange-500 transition-all text-xs font-bold tracking-widest">Tamil</button>
            </div>
        </div>
    </div>

    <!-- Divine Background -->
    <div class="divine-bg">
        <div class="aura" style="top: 5%; left: 10%;"></div>
        <div class="aura" style="bottom: 10%; right: 10%; background: radial-gradient(circle, rgba(59, 130, 246, 0.06) 0%, transparent 70%);"></div>
        <div id="particle-container"></div>
    </div>

    <!-- Header -->
    <header class="z-30 py-4 px-6 border-b border-white/10 bg-black/40 backdrop-blur-2xl flex justify-between items-center shrink-0">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-orange-900/30 rounded-full flex items-center justify-center text-orange-500 shadow-xl border border-orange-500/20">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
            </div>
            <div>
                <h1 class="text-xl tracking-[0.3em] text-white uppercase font-bold leading-none">Gita Marg</h1>
                <p class="text-[9px] text-orange-500 uppercase tracking-[0.4em] mt-1 font-bold">Divine Intelligence</p>
            </div>
        </div>
        <div class="flex gap-3 items-center">
            <button id="reflection-btn" class="hidden md:flex items-center gap-2 text-[10px] uppercase font-bold text-orange-400 bg-orange-400/10 px-4 py-2.5 rounded-xl transition-all hover:bg-orange-400/20 border border-orange-400/20" title="Get Soul Insight">
                âœ¨ Insight
            </button>
            <button onclick="resetChat()" class="text-stone-400 hover:text-white p-2.5 transition-colors rounded-full bg-white/5 border border-white/5">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
            </button>
        </div>
    </header>

    <!-- Main Chat Content -->
    <main class="flex-grow flex flex-col overflow-hidden relative">
        <div id="chat-window" class="chat-container">
            
            <div id="welcome-content" class="max-w-4xl mx-auto w-full py-8 space-y-8 flex flex-col items-center">
                <!-- Daily Quote Card -->
                <div id="daily-card" class="w-full parchment p-8 rounded-[2.5rem] text-center space-y-4 border border-white/10">
                    <span class="text-[10px] uppercase tracking-[0.5em] text-orange-500 font-bold block">Ethereal Thought</span>
                    <p id="daily-text" class="italic text-stone-200 text-xl leading-relaxed font-medium"></p>
                </div>

                <!-- Welcome Screen -->
                <div id="welcome-message" class="text-center space-y-12">
                    <div class="space-y-4">
                        <h2 class="text-3xl text-white font-cinzel tracking-[0.2em] uppercase font-bold">Speak, Arjun</h2>
                        <p class="text-stone-400 leading-relaxed max-w-lg mx-auto italic text-lg opacity-80">
                            The chariot of wisdom stands ready. Pour your soul into words.
                        </p>
                    </div>

                    <!-- Mood Selection Grid -->
                    <div class="space-y-10">
                        <h3 class="text-[11px] uppercase tracking-[0.4em] text-stone-500 font-bold">Current State of Mind</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 px-4">
                            <button onclick="prefillMood('ðŸ¤”', 'I am confused about a big life decision.')" class="mood-btn p-6 rounded-[2rem] flex flex-col items-center gap-4 group">
                                <span class="text-3xl group-hover:scale-110 transition-transform">ðŸ¤”</span>
                                <span class="text-[9px] font-bold uppercase tracking-[0.3em] text-stone-400 group-hover:text-orange-400 transition-colors">Confused</span>
                            </button>
                            <button onclick="prefillMood('ðŸ˜Ÿ', 'I am feeling anxious about my future.')" class="mood-btn p-6 rounded-[2rem] flex flex-col items-center gap-4 group">
                                <span class="text-3xl group-hover:scale-110 transition-transform">ðŸ˜Ÿ</span>
                                <span class="text-[9px] font-bold uppercase tracking-[0.3em] text-stone-400 group-hover:text-orange-400 transition-colors">Anxious</span>
                            </button>
                            <button onclick="prefillMood('ðŸ”¥', 'I am feeling angry and restless.')" class="mood-btn p-6 rounded-[2rem] flex flex-col items-center gap-4 group">
                                <span class="text-3xl group-hover:scale-110 transition-transform">ðŸ”¥</span>
                                <span class="text-[9px] font-bold uppercase tracking-[0.3em] text-stone-400 group-hover:text-orange-400 transition-colors">Angry</span>
                            </button>
                            <button onclick="prefillMood('ðŸ§˜', 'Help me find the true purpose of my existence.')" class="mood-btn p-6 rounded-[2rem] flex flex-col items-center gap-4 group">
                                <span class="text-3xl group-hover:scale-110 transition-transform">ðŸ§˜</span>
                                <span class="text-[9px] font-bold uppercase tracking-[0.3em] text-stone-400 group-hover:text-orange-400 transition-colors">Seeking</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Message List -->
            <div id="messages-anchor" class="max-w-4xl mx-auto w-full"></div>
        </div>

        <!-- Typing Indicator -->
        <div id="typing-indicator" class="hidden absolute bottom-28 left-1/2 -translate-x-1/2 px-8 py-3 bg-black/80 backdrop-blur-2xl rounded-full flex items-center space-x-4 text-stone-400 italic text-sm border border-white/10 shadow-2xl z-20">
            <span class="loader border-orange-500"></span>
            <span class="tracking-widest uppercase text-[10px] font-bold">Seeking Wisdom...</span>
        </div>

        <!-- Input Section -->
        <div class="p-6 bg-black/40 backdrop-blur-3xl border-t border-white/5 shrink-0">
            <div class="max-w-4xl mx-auto relative flex items-end gap-4">
                <button id="mic-btn" class="bg-white/5 hover:bg-white/10 text-stone-400 p-5 rounded-[1.5rem] transition-all mb-1 border border-white/10 active:scale-90">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                    </svg>
                </button>

                <div class="relative flex-grow">
                    <textarea 
                        id="user-input" 
                        rows="1" 
                        class="w-full parchment p-4 pr-16 rounded-[1.2rem] transition-all resize-none max-h-48 text-white border border-white/10 placeholder-stone-600 focus:border-orange-500/50 leading-relaxed text-lg" 
                        placeholder="Pour your soul here..."
                        oninput="autoResize(this)"
                    ></textarea>
                    
                    <button id="send-btn" class="absolute right-3 bottom-2 bg-orange-600 hover:bg-orange-700 text-white p-3 rounded-2xl transition-all shadow-2xl disabled:opacity-20 flex items-center justify-center active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                           <path d="M3.4 20.4l17.45-8.48c.32-.15.32-.6 0-.75L3.4 2.6c-.33-.16-.67.14-.54.46l2.12 6.64c.03.1.12.18.23.19l8.29.9c.11.01.11.17 0 .18l-8.29.9c-.11.01-.2.09-.23.19L2.86 19.94c-.13.32.21.62.54.46z"/>
                        </svg>
                    </button>
                </div>
                
                <button id="summary-btn" class="mb-1 p-5 bg-orange-600/10 text-orange-500 rounded-[1.5rem] border border-orange-500/10 hover:scale-105 transition-all shadow-inner" title="Essence of Conversation">
                    âœ¨
                </button>
            </div>
            <p id="lang-hint" class="text-[10px] text-center text-stone-500 mt-4 uppercase tracking-[0.5em] font-bold opacity-60">Language: English â€¢ Ancient Wisdom Engine</p>
        </div>
    </main>

    <!-- Invisible Audio for TTS -->
    <audio id="tts-player" class="hidden"></audio>

    <script>
        const apiKey = ""; 
        const modelName = "gemini-2.5-flash-preview-09-2025";
        const ttsModel = "gemini-2.5-flash-preview-tts";
        
        const chatWindow = document.getElementById('chat-window');
        const welcomeContent = document.getElementById('welcome-content');
        const messagesAnchor = document.getElementById('messages-anchor');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const micBtn = document.getElementById('mic-btn');
        const reflectionBtn = document.getElementById('reflection-btn');
        const summaryBtn = document.getElementById('summary-btn');
        const typingIndicator = document.getElementById('typing-indicator');
        const dailyText = document.getElementById('daily-text');
        const ttsPlayer = document.getElementById('tts-player');
        const langHint = document.getElementById('lang-hint');

        let messageHistory = [];
        let selectedLang = "English";
        let isRecording = false;
        let recognition;

        const SYSTEM_PROMPT = `You are "Gita GPT", an AI guide offering wisdom based on the Bhagavad Gita. 
NEVER claim to be Krishna or a deity. Start every response with "Speak, Arjun," translated to the user's language. Respond in the user's language. Use Gita principles.`;

        function closeInstruction() {
            document.getElementById('instruction-modal').classList.add('hidden');
            document.getElementById('language-modal').classList.remove('hidden');
        }

        function setLang(lang) {
            selectedLang = lang;
            document.getElementById('language-modal').classList.add('hidden');
            langHint.innerText = `Language: ${lang} â€¢ Ancient Wisdom Engine`;
        }

        function createParticles() {
            const container = document.getElementById('particle-container');
            for(let i=0; i<30; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                const size = Math.random() * 2 + 1;
                p.style.width = size + 'px'; p.style.height = size + 'px';
                p.style.left = Math.random() * 100 + 'vw';
                p.style.setProperty('--d', (Math.random() * 12 + 8) + 's');
                p.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(p);
            }
        }
        createParticles();

        const quotes = [
            "Change is the law of the universe.",
            "You have the right to work, but never to the fruit of work.",
            "Man is made by his belief. As he believes, so he is.",
            "Expectation is the root of all misery.",
            "Calmness is the discipline of the mind."
        ];
        dailyText.innerText = quotes[Math.floor(Math.random() * quotes.length)];

        // Speech Recognition
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.onstart = () => { micBtn.classList.add('bg-red-500/20', 'text-red-500'); isRecording = true; };
            recognition.onresult = (e) => { userInput.value = e.results[0][0].transcript; autoResize(userInput); handleSend(); };
            recognition.onend = () => { micBtn.classList.remove('bg-red-500/20', 'text-red-500'); isRecording = false; };
        }
        micBtn.onclick = () => { if (isRecording) recognition.stop(); else recognition.start(); };

        function autoResize(textarea) { textarea.style.height = 'auto'; textarea.style.height = textarea.scrollHeight + 'px'; }

        function prefillMood(emoji, text) { userInput.value = text; autoResize(userInput); handleSend(); }

        function resetChat() {
            messageHistory = [];
            messagesAnchor.innerHTML = '';
            welcomeContent.classList.remove('hidden');
            reflectionBtn.classList.add('hidden');
        }

        // --- PCM to WAV Conversion Helper (Fixes NotSupportedError) ---
        function pcmToWav(base64, sampleRate = 24000) {
            const buffer = Uint8Array.from(atob(base64), c => c.charCodeAt(0)).buffer;
            const length = buffer.byteLength;
            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);

            // RIFF chunk
            view.setUint32(0, 0x52494646, false); // "RIFF"
            view.setUint32(4, 36 + length, true);
            view.setUint32(8, 0x57415645, false); // "WAVE"
            // format chunk
            view.setUint32(12, 0x666d7420, false); // "fmt "
            view.setUint32(16, 16, true); // size
            view.setUint16(20, 1, true); // format PCM
            view.setUint16(22, 1, true); // channel count
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); // byte rate (SampleRate * NumChannels * BitsPerSample/8)
            view.setUint16(32, 2, true); // block align
            view.setUint16(34, 16, true); // bits per sample
            // data chunk
            view.setUint32(36, 0x64617461, false); // "data"
            view.setUint32(40, length, true);

            const combined = new Uint8Array(wavHeader.byteLength + length);
            combined.set(new Uint8Array(wavHeader), 0);
            combined.set(new Uint8Array(buffer), wavHeader.byteLength);

            const blob = new Blob([combined], { type: 'audio/wav' });
            return URL.createObjectURL(blob);
        }

        async function fetchWithBackoff(url, options, retries = 5, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithBackoff(url, options, retries - 1, delay * 2);
                }
                throw error;
            }
        }

        function appendMessage(role, content, isSpecial = false) {
            if (!welcomeContent.classList.contains('hidden')) {
                welcomeContent.classList.add('hidden');
            }
            if (role === 'model') reflectionBtn.classList.remove('hidden');

            const row = document.createElement('div');
            row.className = `message-row ${role === 'user' ? 'user' : 'model'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `message-bubble p-6 rounded-[2rem] shadow-2xl ${
                role === 'user' ? 'bg-orange-600 text-white rounded-tr-none' 
                : isSpecial ? 'bg-gradient-to-br from-orange-400 to-deep-saffron text-white rounded-tl-none'
                : 'parchment text-stone-100 rounded-tl-none border border-white/10 guide-text'
            }`;
            
            bubble.innerHTML = content.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong class="text-orange-400 font-bold">$1</strong>');
            
            if (role === 'model' && !isSpecial) {
                const listenBtn = document.createElement('button');
                listenBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>Listen Insight`;
                listenBtn.className = "text-[10px] uppercase font-bold text-orange-400 hover:text-white transition-colors mt-4 block pt-2 border-t border-white/5";
                listenBtn.onclick = () => playWisdom(content);
                bubble.appendChild(listenBtn);
            }

            row.appendChild(bubble);
            messagesAnchor.appendChild(row);
            
            setTimeout(() => {
                chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'smooth' });
            }, 100);
        }

        async function playWisdom(text) {
            const cleanText = text.replace(/<[^>]*>/g, '').substring(0, 600);
            try {
                const response = await fetchWithBackoff(`https://generativelanguage.googleapis.com/v1beta/models/${ttsModel}:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Say calmly: ${cleanText}` }] }],
                        generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } }
                    })
                });
                const audioData = response.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (audioData) {
                    const audioUrl = pcmToWav(audioData, 24000);
                    ttsPlayer.src = audioUrl;
                    ttsPlayer.play();
                }
            } catch (e) { console.error("TTS Error:", e); }
        }

        reflectionBtn.onclick = async () => {
            if (messageHistory.length === 0) return;
            typingIndicator.classList.remove('hidden');
            try {
                const lastMsg = messageHistory[messageHistory.length - 1].parts[0].text;
                const response = await fetchWithBackoff(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Based on: "${lastMsg}", in ${selectedLang}, generate a deep 1-sentence poetic spiritual prompt.` }] }],
                        systemInstruction: { parts: [{ text: "You are a spiritual guide." }] }
                    })
                });
                const insight = response.candidates?.[0]?.content?.parts?.[0]?.text;
                if (insight) appendMessage('model', `âœ¨ Insight: ${insight}`, true);
            } catch (e) { console.error(e); }
            finally { typingIndicator.classList.add('hidden'); }
        };

        summaryBtn.onclick = async () => {
            if (messageHistory.length < 2) return;
            typingIndicator.classList.remove('hidden');
            try {
                const historyText = messageHistory.map(m => m.parts[0].text).join("\n");
                const response = await fetchWithBackoff(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Summarize this in ${selectedLang}: ${historyText}` }] }],
                        systemInstruction: { parts: [{ text: "You are a wise philosopher." }] }
                    })
                });
                const summary = response.candidates?.[0]?.content?.parts?.[0]?.text;
                if (summary) appendMessage('model', `âœ¨ Wisdom Essence: ${summary}`, true);
            } catch (e) { console.error(e); }
            finally { typingIndicator.classList.add('hidden'); }
        };

        async function handleSend() {
            const text = userInput.value.trim();
            if (!text || sendBtn.disabled) return;
            userInput.value = ''; userInput.style.height = 'auto';
            appendMessage('user', text);
            messageHistory.push({ role: "user", parts: [{ text: text }] });
            sendBtn.disabled = true; typingIndicator.classList.remove('hidden');
            try {
                const response = await fetchWithBackoff(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: messageHistory,
                        systemInstruction: { parts: [{ text: `${SYSTEM_PROMPT} Ensure the answer is in ${selectedLang}.` }] },
                        tools: [{ "google_search": {} }]
                    })
                });
                const aiResponse = response.candidates?.[0]?.content?.parts?.[0]?.text;
                if (aiResponse) {
                    appendMessage('model', aiResponse);
                    messageHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                }
            } catch (error) { console.error(error); } 
            finally { sendBtn.disabled = false; typingIndicator.classList.add('hidden'); }
        }
        sendBtn.onclick = handleSend;
        userInput.onkeydown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } };
        window.onload = () => userInput.focus();
    </script>
</body>
</html>